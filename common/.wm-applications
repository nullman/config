#!/usr/bin/env bash
#===============================================================================
# .wm-applications
#
# Launch Standard Window Manager Applicaitons
#
# File to be sourced from window manager launch script.
#
# Author: Kyle W T Sherman <kylewsherman@gmail.com>
#===============================================================================

# check if executable command is found in the path
_command() {
    command -v "$1" >/dev/null 2>&1
}

# # delay running a command (SECONDS COMMAND)
# _delay() {
#     local delay=$1
#     shift
#     sleep ${delay} && eval "$@"
# }

# simple x hotkey daemon
# (might have been started already by .xprofile)
[ -f "${HOME}/bin/run-sxhkd" ] && ${HOME}/bin/run-sxhkd &

# qubes os
if [ "$(uname -n)" == "dom0" ] ; then
    # qubes volume block device attach home partition to personal
    (for device in $(qvm-block list --all | grep -e 'Unknown device' -e 'personal' | sed 's/ .*$//') ; do
         qvm-block detach personal ${device}
     done
     qvm-block attach --persistent --option frontend-dev=xvdz personal $(qvm-block list dom0 | grep 'dom0' | sed 's/ .*$//')) &

    # qubes usb device attach bluetooth to personal
    (for device in $(qvm-usb list --all | grep -e 'Unknown device' -e 'personal' | sed 's/ .*$//') ; do
         qvm-usb detach personal ${device}
     done
     qvm-usb attach --persistent personal $(qvm-usb list sys-net | grep '8087:0aaa' | sed 's/ .*$//')) &

    # xfce session
    _command xfce4-session && xfce4-session &

    # # system bar
    # _command xfce4-panel && xfce4-panel &

    # # system wallpaper displays
    # [ -f "${HOME}/bin/system-wallpaper-displays" ] && source "${HOME}/bin/system-wallpaper-displays"

    # hide mouse when not in use
    _command unclutter && unclutter &

    # custom bspwm external rules to handle vm classes
    bspc config external_rules_command ${HOME}/.config/bspwm/bspwm-external-rules &
fi

# other os
if [ "$(uname -n)" != "dom0" ] ; then
    # xfce settings
    #_command xfsettingsd && xfsettingsd &

    # ssh-agent
    #_command ssh-agent && ssh-agent &
    #_command ssh-add && ssh-add &

    # key bindings
    #xmodmap "${HOME}/.xmodmaprc" &
    #set-xkb &
    #xbindkeys &

    # policykit authentation agent
    if [ -x /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 ] ; then
        /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &
        #eval "$(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh,gpg)" &
    fi
    #_command lxpolkit && lxpolkit &

    # compositor
    _command picom && picom -b &

    # system bar
    if ! pgrep -x stumpwm >/dev/null ; then
        [ -f "${HOME}/bin/system-bar" ] && source "${HOME}/bin/system-bar"
    fi

    # system wallpaper displays
    [ -f "${HOME}/bin/system-wallpaper-displays" ] && source "${HOME}/bin/system-wallpaper-displays"

    # full-screen task-switcher
    #_command skippy-xd && skippy-xd --config "${HOME}/.config/skippy-xd/skippy-xd.rc" --start-daemon &

    # localize user system folders
    #_command xdg-user-dirs-gtk-update && xdg-user-dirs-gtk-update &

    # tell firefox to match theme
    #_command ff-theme-util && ff-theme-util &

    # clipmenu
    _command clipmenud && clipmenud &

    # eject-applet
    #_command eject-applet && eject-applet &

    # set cursor theme
    _command fix_xcursor && fix_xcursor &

    # hide mouse when not in use
    _command unclutter && unclutter &

    # wallpaper manager
    _command nitrogen && nitrogen --restore &

    # screen saver
    #_command xscreensaver && xscreensaver -no-splash &

    # screen saver
    #_command xautolock && xautolock -time 30 -locker blurlock & # lock screen after 30 minutes

    # rebuild wm menu
    #sleep 10 && _command mmaker && mmaker --force openbox &
fi

# launch custom machine-specific applications
[ -x "${HOME}/.wm-applications-machine" ] && ${HOME}/.wm-applications-machine

#===============================================================================
# End of File
#===============================================================================
