#!/usr/bin/env bash
#===============================================================================
# rofi-menu
#
# Present a menu of rofi menus.
#
# Author: Kyle W T Sherman
#===============================================================================

lsopts=("-1" "--group-directories-first" "--file-type")

# display usage information
_usage() {
    cat <<EOF
Usage: $(basename "$0") [MENU]
Present a menu of rofi menus.
MENU:
  NONE    Menu of Menus
  qemu    QEMU Emulator
  sounds  Play Sounds
  ssh     SSH into Systems
EOF
}

# handle no arguments given
if [[ $# -lt 1 ]] ; then
    menus=(
        "Qemu"
        "Sounds"
        "SSH"
    )
    menu=$(printf "%s\n" "${menus[@]}" | rofi -dmenu -i -p 'Menu' -hide-scrollbar)
else
    menu=$1
fi

# handle menu
menu=$(echo "${menu}" | tr '[:upper:]' '[:lower:]')
case "${menu}" in
    qemu)
        # generate and display a list of qemu emulators
        if [[ $# -lt 2 ]] ; then
            sel=$(ls "${lsopts[@]}" "${HOME}/qemu" | rofi -dmenu -i -p 'Qemu' -hide-scrollbar)
        else
            sel=$2
        fi

        # launch selected qemu emulator
        if [[ -n "${sel}" ]] ; then
            (cd "${HOME}/qemu/${sel}" && ./run &)
        fi
        ;;

    sounds)
        sounddirs=(
            "${HOME}/Sounds"
            "${HOME}/sounds"
        )
        stop="[Stop Player]"
        up="[..]"

        # generate and display a list of sound files and directories to choose from
        _select() {
            if [[ -z "${sel}" ]] ; then
                local opts=("${stop}" "$(ls "${lsopts[@]}" "${sounddir}")")
            else
                local opts=("${up}" "$(ls "${lsopts[@]}" "${selpath}")")
            fi
            sel=$(printf '%s\n' "${opts[@]}" | rofi -dmenu -i -p 'Sounds' -hide-scrollbar)
        }

        _kill_ffplay() {
            # stop any currently playing sounds
            # (regardless of selection to prevent sounds from doubling up)
            [[ -n "$(pgrep ffplay)" ]] && pkill ffplay
        }

        # find sound directory
        sounddir=
        for dir in "${sounddirs[@]}" ; do
            [[ -z "${sounddir}" ]] && [[ -d "${dir}" ]] && sounddir="${dir}"
        done
        [[ -z "${sounddir}" ]] && exit 1

        # generate and display a list of sound files and directories to choose from
        selpath="${sounddir}"
        if [[ $# -lt 2 ]] ; then
            sel=""
            _select
        else
            sel="$2"
        fi

        # process selection
        if [[ -n "${sel}" ]] ; then
            while true ; do
                if [[ -z "${sel}" ]] ; then
                    _select
                fi

                sel=$(echo "${sel}" | sed 's%/$%%')
                selpath="${sounddir}/${sel}"
                echo "selpath: ${selpath}"

                if [[ "${sel}" == "${stop}" ]] ; then
                    _kill_ffplay
                    break
                fi

                # handle going up a directory
                if [[ "${sel:0-${#up}}" == "${up}" ]] ; then
                    dirlen=$((${#selpath}-${#up}-1))
                    dir="${selpath:0:${dirlen}}"
                    updir="$(cd "${dir}" && cd .. && pwd)"
                    sel="${updir:${#sounddir}}"
                    continue
                fi

                # handle traversing into a directory
                if [[ -d "${selpath}" ]] ; then
                    dir="${sel}"
                    _select
                    sel="${dir}/${sel}"
                    continue
                fi

                # handle playing a sound file
                _kill_ffplay
                if $(echo "${sel}" | grep -q "Ambient Sound Effects") ; then
                    echo "Playing: ${sel} (in a loop)"
                    ffplay -nodisp -loop 0 "${selpath}"
                else
                    echo "Playing: ${sel}"
                    ffplay -nodisp -autoexit "${selpath}"
                fi
                break
            done
        fi
        ;;

    ssh)
        if [[ $# -lt 2 ]] ; then
            servers=(
                "morpheus"
                "raspad"
                "switch"
            )
            sel=$(printf "%s\n" "${servers[@]}" | rofi -dmenu -i -p 'SSH' -hide-scrollbar)
        else
            sel=$2
        fi

        # launch selected ssh connection
        if [[ -n "${sel}" ]] ; then
            user="${USER}"
            [[ "${sel}" == "raspad" ]] && user="pi"
            (alacritty -t "SSH ${sel}" -e "ssh" "${user}@${sel}" &)
        fi
        ;;
esac

exit 0

#===============================================================================
# End of File
#===============================================================================
