#!/usr/bin/env bash
BASE_FILE="/tmp/conky-weather"
ESC=$(printf '\33')

curl --silent "wttr.in/San+Diego?u" | head -n 7 > "${BASE_FILE}.txt"

sed "s/^Weather report: .*$/\${goto 50}\${font MesloLGS Nerd Font:bold:size=16}San Diego\${font}/ ; \
    s/${ESC}\[0m/\${font}\${color}/g ; \
    s/${ESC}\[1m/\${font MesloLGS Nerd Font Mono:bold}/g ; \
    s/${ESC}\[38;5;\([0-9]\{3\}\)m/\${color _\1_}/g" \
    "${BASE_FILE}.txt" | \
    while IFS= read -r line; do
        echo "${line}" | sed 's/_\([0-9]\{3\}\)_/\n\1\n/g' | \
            while IFS= read -r token ; do
                if [[ "${token}" =~ ^[0-9]{3}$ ]] ; then
                    echo -n "$(/home/user/bin/terminal-color ${token})"
                else
                    echo -n "${token}"
                fi
            done
        echo
    done > "${BASE_FILE}.conky"

cat "${BASE_FILE}.conky"

# # png version [not working]
# curl --silent "wttr.in/San+Diego?u" | head -n -2 > "${BASE_FILE}.txt"
# cat "${BASE_FILE}.txt" | aha --black --style 'font-size:1em' > "${BASE_FILE}.html"
# #magick -density 300 "${BASE_FILE}.html" "${BASE_FILE}.png"
# #firefox --new-instance --screenshot "${BASE_FILE}.png" "file://${BASE_FILE}.html"
# chromium --headless --disable-gpu --screenshot="${BASE_FILE}.png" "file://${BASE_FILE}.html" >/dev/null 2>&1
# magick "${BASE_FILE}.png" -transparent black "${BASE_FILE}.png"
