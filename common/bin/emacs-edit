#!/usr/bin/env bash
#===============================================================================
# emacs-edit
#
# Launch an emacs editor, using emacs server if found.
#
# Author: Kyle W T Sherman
#===============================================================================

set -euo pipefail

# return wether or not terminal is running in screen
inscreen() {
    local cmd=$(ps -o comm -p $(ps -o ppid -p "$$" --no-headers) --no-headers)
    [[ "${cmd}" == "screen" ]] && echo "screen"
}

# set optional wait state
if [[ -v WAIT ]] ; then
    wait=""
else
    wait="--no-wait"
fi
[[ -v DEBUG ]] && echo "wait: ${wait}"

# set optional vi fallback state
if [[ -v VI ]] ; then
    vi=true
else
    vi=false
fi
[[ -v DEBUG ]] && echo "vi: ${vi}"

# determine if emacs client is running under this user
client=0
if [[ "$(emacsclient -e t 2>&1)" == "t" ]] ; then
    client=1
fi

# for older versions look for emacs server socket
if [[ ${client} -eq 0 ]] ; then
    for name in "/tmp/emacs$(id -u)" "/tmp/esrv$(id -u)-$(hostname)" ; do
        if [[ ${client} -eq 0 ]] ; then
            # stat client file
            if [[ -e "${name}" ]] && [[ -n "$(stat ${name} | grep ${USER})" ]] ; then
                client=1
                [[ -v DEBUG ]] && echo "client file: ${name}, client: ${client}"
            fi
        fi
    done
fi
[[ -v DEBUG ]] && echo "client: ${client}"

# determine if screen is running under this user and if emacs is running under it
screen=0
if [[ "$(inscreen)" == "screen" ]] ; then
    if [[ -n "$(ps -e --format pid,ppid,user,args | grep -v grep | grep ${USER} | grep -i screen)" ]] ; then
        if [[ -n "$(ps -e --format pid,ppid,user,args | grep -v grep | grep ${USER} | grep emacs | grep '\-nw')" ]] ; then
            screen=1
        fi
    fi
fi
[[ -v DEBUG ]] && echo "screen: ${screen}"

# pause if debugging
if [[ -v DEBUG ]] ; then
    echo "Press return to start editor"
    read a
fi

# if emacs client is running...
if [[ ${client} -eq 1 ]] ; then
    # if screen is running, switch to emacs window
    if [[ ${screen} -eq 1 ]] ; then
        screen -X select emacs
    fi
    # run emacsclient
    emacsclient ${wait} --alternate-editor=vi "$@"
else
    if [[ ${vi} == true ]] ; then
        if [[ $(command -v vim) ]] ; then
            # launch vim
            vim "$@"
        elif [[ $(command -v vi) ]] ; then
            # launch vi
            vi "$@"
        else
            echo "Could not find an editor"
        fi
    else
        # launch a quick local emacs
        emacs --no-site-file --no-init-file -nw "$@"
    fi
fi

#===============================================================================
# End of File
#===============================================================================
