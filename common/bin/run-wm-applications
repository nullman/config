#!/usr/bin/env bash
#===============================================================================
# run-wm-applications
#
# Launch Standard Window Manager Applicaitons
#
# File to be sourced from window manager launch script.
#
# Author: Kyle W T Sherman <kylewsherman@gmail.com>
#===============================================================================

# check if executable command is found in the path
_command() {
    command -v "$1" >/dev/null 2>&1
}

# run executable command if found in the path
_run() {
    command -v "$1" >/dev/null 2>&1 && "$@"
}

# run executable command if found in the path and not already running
_once() {
    if command -v "$1" >/dev/null 2>&1 && ! pidof -q "$1" ; then
        "$@" &
    fi
}

# source script if found in the path
_source() {
    [ -f "$1" ] && source "$@"
}

# # delay running a command (SECONDS COMMAND)
# _delay() {
#     local delay=$1
#     shift
#     sleep ${delay} && eval "$@"
# }

# simple x hotkey daemon
# (might have been started already by .xprofile)
_run ${HOME}/bin/run-sxhkd &

# qubes os
if [ "$(uname -n)" == "dom0" ] ; then
    # qubes volume block device attach home partition to personal
    (for device in $(qvm-block list --all | grep -e 'Unknown device' -e 'personal' | sed 's/ .*$//') ; do
         qvm-block detach personal ${device}
     done
     qvm-block attach --persistent --option frontend-dev=xvdz personal $(qvm-block list dom0 | grep 'dom0' | sed 's/ .*$//')) &

    # qubes usb device attach bluetooth to personal
    (for device in $(qvm-usb list --all | grep -e 'Unknown device' -e 'personal' | sed 's/ .*$//') ; do
         qvm-usb detach personal ${device}
     done
     qvm-usb attach --persistent personal $(qvm-usb list sys-net | grep '8087:0aaa' | sed 's/ .*$//')) &

    # desktop 10 is used for Qube Manager and dom0 terminal
    bspc config desktop 10 --layout tiled

    # xfce session
    _once xfce4-session &

    # # system bar
    # _once xfce4-panel &

    # # system wallpaper displays
    # _source "${HOME}/bin/system-wallpaper-displays"

    # hide mouse when not in use
    _once unclutter &

    # custom bspwm external rules to handle vm classes in qubes os
    bspc config external_rules_command ${HOME}/.config/bspwm/bspwm-external-rules-qubes &
fi

# other os
if [ "$(uname -n)" != "dom0" ] ; then
    # xfce settings
    #_once xfsettingsd &

    # ssh-agent
    #_once ssh-agent &
    #_once ssh-add &

    # key bindings
    #xmodmap "${HOME}/.xmodmaprc" &
    #set-xkb &
    #xbindkeys &

    # policykit authentation agent
    if [ -x /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 ] ; then
        /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &
        #eval "$(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh,gpg)" &
    fi
    #_once lxpolkit &

    # compositor
    _once picom -b &

    # system bar
    if ! pgrep -x stumpwm >/dev/null ; then
        _source "${HOME}/bin/system-bar"
    fi

    # system wallpaper displays
    _source "${HOME}/bin/system-wallpaper-displays"

    # full-screen task-switcher
    #_once skippy-xd --config "${HOME}/.config/skippy-xd/skippy-xd.rc" --start-daemon &

    # localize user system folders
    #_once xdg-user-dirs-gtk-update &

    # tell firefox to match theme
    #_once ff-theme-util &

    # clipmenu
    _once clipmenud &

    # eject-applet
    #_once eject-applet &

    # set cursor theme
    _once fix_xcursor &

    # hide mouse when not in use
    _once unclutter &

    # wallpaper manager
    _once nitrogen --restore &

    # screen saver
    #_once xscreensaver -no-splash &

    # screen saver
    #_once xautolock -time 30 -locker blurlock & # lock screen after 30 minutes

    # rebuild wm menu
    #sleep 10 && _once mmaker --force openbox &
fi

# launch custom machine-specific applications
_run ${HOME}/.wm-applications-machine

#===============================================================================
# End of File
#===============================================================================
