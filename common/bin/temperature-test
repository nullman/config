#!/usr/bin/env bash
#===============================================================================
# temperature-test
#
# Run a temperature test.
#
# Dependencies: lm_sensors sysbench
#
# (Based on Christopher Barnatt's version found in his ExplainingComputers
# videos on Youtube.)
#
# Author: Kyle W T Sherman
#===============================================================================

count=6
opts=
help=0

# check for prerequisite applicaitons
if [[ ! $(command -v sensors) ]] ; then
    echo "lm_sensors is not installed"
    exit 1
fi

if [[ ! $(command -v sysbench) ]] ; then
    echo "sysbench is not installed"
    exit 1
fi

# args
while [[ $# -gt 0 ]] ; do
    key="$1"
    case "${key}" in
        -c|--count)
            count="$2"
            shift
            shift
            ;;
        -f|--fahrenheit)
            opts="$1"
            shift
            ;;
        *)
            help=1
            shift
            ;;
    esac
done

# help
if [[ ${help} -eq 1 ]] ; then
    echo "Usage: $(basename $0) [OPTIONS]"
    echo "  OPTIONS:"
    echo "    -c, --count       number of 10 second tests to run [6]"
    echo "    -f, --fahrenheit  show temperatures in degrees fahrenheit"
    exit 1
fi

get-temp() {
    sensors ${opts} | grep "^Package id 0:" | sed 's/^Package id 0: \+// ; s/ \+(high.*$//'
    #sensors ${opts} | grep "^Core 0" | sed 's/^Core 0: \+// ; s/ \+(high.*$//'
}

threads="$(lscpu -p | grep -v "^#" | wc -l)"

echo "Performing CPU temperature test on ${threads} threads..."

for x in $(seq ${count}) ; do
    c="00000${x}"
    echo -n "[${c: $((-${#count}))}/${count}] "
    get-temp $1
    sysbench --test=cpu --cpu-max-prime=25000 --num-threads=${threads} run > /dev/null 2>&1
done

echo
get-temp $1

#===============================================================================
# End of File
#===============================================================================
