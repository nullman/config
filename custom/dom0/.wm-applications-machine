#!/usr/bin/env bash
#===============================================================================
# bspwmrc-applications
#
# Binary Space Partitioning Window Manager (bspwm) auto-start applications
# script.
#
# Reference: https://github.com/baskerville/bspwm
#===============================================================================

# run executable command if found in the path
_run() {
    command -v "$1" >/dev/null 2>&1 && "$@"
}

# run executable command if found in the path and not already running
_once() {
    if command -v "$1" >/dev/null 2>&1 && ! pidof -q "$1" ; then
        "$@" &
    fi
}

# delay running a command (SECONDS COMMAND)
_delay() {
    local delay=$1
    shift
    sleep ${delay} && eval "$@"
}

# run background applications and services
#_once xscreensaver -no-splash &
#_once xautolock -time 30 -locker 'xscreensaver-command -lock' & # lock screen after 30 minutes
#_once xautolock -time 30 -locker blurlock & # lock screen after 30 minutes
#_once mpd ${HOME}/.mpd/mpd.conf &
#_once dropbox start &
#_once barriers --config ${HOME}/.barrier.conf &
#_once barrierc SERVER &
#_once emacs --daemon &

# delay so that networking has time to connect
#_delay 0

# run dom0 applications
bspc desktop --focus 10
#(bspc rule --add --one-shot 'qubes-qube-manager' --state tiled && qubes-qube-manager) &
qubes-qube-manager &
sleep 6s && bspc node --state tiled
alacritty -e ${HOME}/bin/run-screen &

# run personal vm applications
(
    qvm-start personal
    sleep 10s && (
        bspc desktop --focus 1

        # prompt for keyring authentication on personal vm
        qvm-run personal "keyring get SecretService \$(id -un)" 2>/dev/null &

        # start user services
        qvm-run personal "systemctl --user enable --now clipmenud" &
        qvm-run personal "systemctl --user enable --now mpd" &
        qvm-run personal "systemctl --user enable --now mpdris" &

        # run application launcher
        _run ${HOME}/bin/application-launcher &
     )
) &

#===============================================================================
# End of File
#===============================================================================
